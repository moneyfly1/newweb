# 订阅升级（增加设备 + 可选续期）计费说明与示例

单价：**每设备每年** 使用配置 `custom_package_price_per_device_year`（默认 40 元）。下例均按 **40 元/设备/年** 计算。

---

## 计费公式

- **仅增加设备（不续期）**  
  应付 = `新增设备数 × 单价 × (剩余天数 / 365)`

- **仅续期（不增加设备）**  
  应付 = `当前设备数 × 单价 × (续期月数 / 12)`

- **增加设备且续期**  
  应付 = **原设备续期费** + **新增设备费**  
  - 原设备续期费 = `当前设备数 × 单价 × (续期月数 / 12)`  
  - 新增设备费 = `新增设备数 × 单价 × (剩余天数/365 + 续期月数/12)`

---

## 示例 1：剩余半年，增加 5 个设备（不续期）

- 剩余时间：6 个月  
- 增加设备：5  
- 续期：0  

计算：`5 × 40 × (180/365) ≈ 98.63` → **约 98.63 元**（若按整半年 0.5 年则为 `5 × 40 × 0.5 = 100`，按天则略少）

---

## 示例 2：剩余 3 个月，增加 5 个设备（不续期）

- 剩余时间：90 天  
- 增加设备：5  

计算：`5 × 40 × (90/365) ≈ 49.32` → **约 49.32 元**

---

## 示例 3：剩余 1.5 年，原 5 设备，增加 5 设备（不续期）

- 剩余时间：1.5 年（约 548 天）  
- 当前设备：5，增加：5  

计算：`5 × 40 × 1.5 = 300` → **300 元** ✓（与您给的例子一致）

---

## 示例 4：原 10 设备、剩余 1.5 年，增加 5 设备（不续期）

- 剩余时间：1.5 年  
- 当前设备：10，增加：5  

计算：`5 × 40 × 1.5 = 300` → **300 元** ✓

---

## 示例 5：原 10 设备、剩余 1.5 年，增加 5 设备并续期 1 年

- 剩余时间：1.5 年  
- 当前设备：10，增加：5  
- 续期：12 个月  

**原 10 台设备续期 1 年：**  
`10 × 40 × (12/12) = 400` → 400 元  

**新增 5 台设备覆盖「剩余 1.5 年 + 续期 1 年」= 2.5 年：**  
`5 × 40 × 2.5 = 500` → 500 元  

**合计：400 + 500 = 900 元** ✓（与您给的例子一致）

---

## 逻辑小结

| 场景           | 计费方式 |
|----------------|----------|
| 只加设备       | 按「剩余天数」为新增设备计费 |
| 只续期         | 按「续期月数」为当前设备数计费 |
| 加设备 + 续期  | 原设备按续期月数计费 + 新设备按「剩余 + 续期」总时长计费 |

API：

- **计算金额**：`POST /api/v1/orders/upgrade/calc`，body：`{ "add_devices": 5, "extend_months": 0 }` 或带 `extend_months`  
- **创建订单**：`POST /api/v1/orders/upgrade`，body：`{ "add_devices": 5, "extend_months": 12, "coupon_code": "" }`  
- 支付成功后：订阅的 `device_limit` 增加 `add_devices`，若 `extend_months > 0` 则 `expire_time` 在原基础上增加对应月数。
